<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.rmp.auto.mapper.UserRemindMapperCustom">
	
	<resultMap id="UserRemindBean" type="com.rmp.auto.model.UserRemindBean">
	    <id column="id" jdbcType="BIGINT" property="id" />
	    <result column="user_id" jdbcType="BIGINT" property="userId" />
	    <result column="type" jdbcType="INTEGER" property="type" />
	    <result column="type_id" jdbcType="BIGINT" property="typeId" />
	    <result column="advance_date" jdbcType="INTEGER" property="advanceDate" />
	    <result column="advance_day" jdbcType="INTEGER" property="advanceDay" />
	    <result column="remind_date" jdbcType="INTEGER" property="remindDate" />
	    <result column="is_delete" jdbcType="INTEGER" property="isDelete" />
	    <result column="version" jdbcType="INTEGER" property="version" />
	    <result column="create_time" jdbcType="BIGINT" property="createTime" />
	    <result column="update_time" jdbcType="BIGINT" property="updateTime" />
	</resultMap>
  
	<sql id="advance_day">
		(
		CASE 
			WHEN cmd.advance_type = 1 THEN 1 
			WHEN cmd.advance_type = 2 THEN 2 
			WHEN cmd.advance_type = 3 THEN 3 
			WHEN cmd.advance_type = 4 THEN 5 
			WHEN cmd.advance_type = 5 THEN 7 
			WHEN cmd.advance_type = 6 THEN 14 
			WHEN cmd.advance_type = 7 THEN 30 
			ELSE 0 
		END
		)
	</sql>
	
	<sql id="table">
		FROM t_customer_memorial_day cmd 
		
		INNER JOIN t_customer c ON cmd.customer_id = c.id AND c.is_delete = 0
		INNER JOIN t_user u ON c.user_id = u.id AND u.is_delete = 0
		
		WHERE cmd.is_delete = 0 
	</sql>
	
	
	<delete id="truncate" >
		TRUNCATE TABLE t_user_remind
	</delete>
	
	
	<insert id="insertBy1ToYmd" parameterType="com.rmp.auto.model.UserRemindBean" >
		INSERT INTO `t_user_remind` (`user_id`, `type`, `type_id`, `advance_date`, `advance_day`, `remind_date`)
		SELECT 
			u.id user_id
			, 1 type
			, cmd.id type_id
			, ${advanceDate} advance_date
			, <include refid="advance_day" /> advance_day
			, cmd.occur_date remind_date
		<include refid="table" />
		AND cmd.occur_type = 1 
		AND cmd.occur_date = date_format(date_add(str_to_date('#{ymd}', '%Y%m%d'), INTERVAL +<include refid="advance_day" /> DAY),'%Y%m%d')
		<selectKey keyProperty="id" order="AFTER" resultType="java.lang.Long">
			SELECT LAST_INSERT_ID()
	    </selectKey>
	</insert>
	
	<insert id="insertBy1ToYmdNow" parameterType="com.rmp.auto.model.UserRemindBean" >
		INSERT INTO `t_user_remind` (`user_id`, `type`, `type_id`, `advance_date`, `advance_day`, `remind_date`)
		SELECT 
			u.id user_id
			, 1 type
			, cmd.id type_id
			, ${advanceDate} advance_date
			, 0 advance_day
			, cmd.occur_date remind_date
		<include refid="table" />
		AND cmd.occur_type = 1 
		AND cmd.occur_date = #{ymd}
		<selectKey keyProperty="id" order="AFTER" resultType="java.lang.Long">
			SELECT LAST_INSERT_ID()
	    </selectKey>
	</insert>
	
	
	<insert id="insertBy1ToMd" parameterType="com.rmp.auto.model.UserRemindBean" >
		INSERT INTO `t_user_remind` (`user_id`, `type`, `type_id`, `advance_date`, `advance_day`, `remind_date`)
		SELECT 
			u.id user_id
			, 1 type
			, cmd.id type_id
			, ${advanceDate} advance_date
			, <include refid="advance_day" /> advance_day
			, cmd.occur_date remind_date
		<include refid="table" />
		AND cmd.occur_type = 2
		AND cmd.occur_date = date_format(date_add(str_to_date('#{md}', '%Y%m%d'), INTERVAL +<include refid="advance_day" /> DAY),'%m%d')
		<selectKey keyProperty="id" order="AFTER" resultType="java.lang.Long">
			SELECT LAST_INSERT_ID()
	    </selectKey>
	</insert>
	
	<insert id="insertBy1ToMdNow" parameterType="com.rmp.auto.model.UserRemindBean" >
		INSERT INTO `t_user_remind` (`user_id`, `type`, `type_id`, `advance_date`, `advance_day`, `remind_date`)
		SELECT 
			u.id user_id
			, 1 type
			, cmd.id type_id
			, ${advanceDate} advance_date
			, 0 advance_day
			, cmd.occur_date remind_date
		<include refid="table" />
		AND cmd.occur_type = 2
		AND cmd.occur_date = #{md}
		<selectKey keyProperty="id" order="AFTER" resultType="java.lang.Long">
			SELECT LAST_INSERT_ID()
	    </selectKey>
	</insert>
	
	
	<insert id="insertBy1ToD" parameterType="com.rmp.auto.model.UserRemindBean" >
		INSERT INTO `t_user_remind` (`user_id`, `type`, `type_id`, `advance_date`, `advance_day`, `remind_date`)
		SELECT 
			u.id user_id
			, 1 type
			, cmd.id type_id
			, 20181119 advance_date
			, <include refid="advance_day" /> advance_day
			, cmd.occur_date remind_date
		<include refid="table" />
		AND cmd.occur_type = 2
		AND cmd.occur_date = date_format(date_add(str_to_date('#{d}', '%Y%m%d'), INTERVAL +<include refid="advance_day" /> DAY),'%d')
		<selectKey keyProperty="id" order="AFTER" resultType="java.lang.Long">
			SELECT LAST_INSERT_ID()
	    </selectKey>
	</insert>
	
	<insert id="insertBy1ToDNow" parameterType="com.rmp.auto.model.UserRemindBean" >
		INSERT INTO `t_user_remind` (`user_id`, `type`, `type_id`, `advance_date`, `advance_day`, `remind_date`)
		SELECT 
			u.id user_id
			, 1 type
			, cmd.id type_id
			, ${advanceDate} advance_date
			, 0 advance_day
			, cmd.occur_date remind_date
		<include refid="table" />
		AND cmd.occur_type = 2
		AND cmd.occur_date = #{d}
		<selectKey keyProperty="id" order="AFTER" resultType="java.lang.Long">
			SELECT LAST_INSERT_ID()
	    </selectKey>
	</insert>
	
	
	<insert id="insertBy1ToW" parameterType="com.rmp.auto.model.UserRemindBean" >
		INSERT INTO `t_user_remind` (`user_id`, `type`, `type_id`, `advance_date`, `advance_day`, `remind_date`)
		SELECT 
			u.id user_id
			, 1 type
			, cmd.id type_id
			, ${advanceDate} advance_date
			, <include refid="advance_day" /> advance_day
			, cmd.occur_date remind_date
		<include refid="table" />
		AND cmd.occur_type = 4
		AND cmd.occur_date = (
			CASE 
				WHEN date_format(date_add(str_to_date('#{w}', '%Y%m%d'), INTERVAL +<include refid="advance_day" /> DAY),'%w') = 0 THEN 7
				ELSE date_format(date_add(str_to_date('#{w}', '%Y%m%d'), INTERVAL +<include refid="advance_day" /> DAY),'%w')
			END)
		<selectKey keyProperty="id" order="AFTER" resultType="java.lang.Long">
			SELECT LAST_INSERT_ID()
	    </selectKey>
	</insert>
	
	<insert id="insertBy1ToWNow" parameterType="com.rmp.auto.model.UserRemindBean" >
		INSERT INTO `t_user_remind` (`user_id`, `type`, `type_id`, `advance_date`, `advance_day`, `remind_date`)
		SELECT 
			u.id user_id
			, 1 type
			, cmd.id type_id
			, ${advanceDate} advance_date
			, 0 advance_day
			, cmd.occur_date remind_date
		<include refid="table" />
		AND cmd.occur_type = 4
		AND cmd.occur_date = #{w}
		<selectKey keyProperty="id" order="AFTER" resultType="java.lang.Long">
			SELECT LAST_INSERT_ID()
	    </selectKey>
	</insert>
	
	
	<insert id="insertBy2" parameterType="com.rmp.auto.model.UserRemindBean" >
		INSERT INTO `t_user_remind` (`user_id`, `type`, `type_id`, `advance_date`, `advance_day`, `remind_date`)
		SELECT 
			u.id user_id
			, 2 type
			, cf.id type_id
			, ${advanceDate} advance_date
			, #{advanceDay} advance_day
			, cf.birthday remind_date
		FROM t_customer_family cf 
		
		INNER JOIN t_customer c ON cf.customer_id = c.id AND c.is_delete = 0
		INNER JOIN t_user u ON c.user_id = u.id AND u.is_delete = 0
		
		WHERE cf.is_delete = 0 
		AND cf.birthday > 0
		
		AND cf.birthday = date_format(date_add(str_to_date('#{ymd}', '%Y%m%d'), INTERVAL +#{advanceDay} DAY),'%Y%m%d')
		<selectKey keyProperty="id" order="AFTER" resultType="java.lang.Long">
			SELECT LAST_INSERT_ID()
	    </selectKey>
	</insert>
	
	<insert id="insertBy3" parameterType="com.rmp.auto.model.UserRemindBean" >
		INSERT INTO `t_user_remind` (`user_id`, `type`, `type_id`, `advance_date`, `advance_day`, `remind_date`)
		SELECT 
			u.id user_id
			, 3 type
			, u.id type_id
			, ${advanceDate} advance_date
			, #{advanceDay} advance_day
			, c.birthday remind_date
		FROM t_customer c 
		
		INNER JOIN t_user u ON c.user_id = u.id AND u.is_delete = 0
		
		WHERE c.is_delete = 0 
		AND c.birthday > 0
		
		AND c.birthday = date_format(date_add(str_to_date('#{ymd}', '%Y%m%d'), INTERVAL +#{advanceDay} DAY),'%Y%m%d')
		<selectKey keyProperty="id" order="AFTER" resultType="java.lang.Long">
			SELECT LAST_INSERT_ID()
	    </selectKey>
	</insert>
	
	<insert id="insertBy4" parameterType="com.rmp.auto.model.UserRemindBean" >
		INSERT INTO `t_user_remind` (`user_id`, `type`, `type_id`, `advance_date`, `advance_day`, `remind_date`)
		SELECT 
			u.id user_id
			, 4 type
			, u.id type_id
			, ${advanceDate} advance_date
			, #{advanceDay} advance_day
			, u.birthday remind_date
		FROM t_user u
		
		WHERE u.is_delete = 0 
		AND u.birthday > 0
		
		AND u.birthday = date_format(date_add(str_to_date('#{ymd}', '%Y%m%d'), INTERVAL +#{advanceDay} DAY),'%Y%m%d')
		<selectKey keyProperty="id" order="AFTER" resultType="java.lang.Long">
			SELECT LAST_INSERT_ID()
	    </selectKey>
	</insert>
</mapper>